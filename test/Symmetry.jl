module Symmetry

using Crystallography
using Crystallography.Symmetry

using Test

@testset "Test rutile structure" begin
    lattice = [
        4 0 0
        0 4 0
        0 0 3
    ]
    positions = [
        0.0 0.0 0.0
        0.5 0.5 0.5
        0.3 0.3 0.0
        0.7 0.7 0.0
        0.2 0.8 0.5
        0.8 0.2 0.5
    ]
    numbers = [14, 14, 8, 8, 8, 8]
    rutile = Cell(numbers, positions, lattice)
    @test getspacegroup(rutile) == ("P4_2/mnm", 136)
    @show irreciprocalmesh(rutile, [6, 6, 6]) ≈ [
        [0.0, 0.0, 0.0, 1.0],
        [0.16666667, 0.0, 0.0, 4.0],
        [0.33333333, 0.0, 0.0, 4.0],
        [0.5, 0.0, 0.0, 2.0],
        [0.16666667, 0.16666667, 0.0, 4.0],
        [0.33333333, 0.16666667, 0.0, 8.0],
        [0.5, 0.16666667, 0.0, 4.0],
        [0.33333333, 0.33333333, 0.0, 4.0],
        [0.5, 0.33333333, 0.0, 4.0],
        [0.5, 0.5, 0.0, 1.0],
        [0.0, 0.0, 0.16666667, 2.0],
        [0.16666667, 0.0, 0.16666667, 8.0],
        [0.33333333, 0.0, 0.16666667, 8.0],
        [0.5, 0.0, 0.16666667, 4.0],
        [0.16666667, 0.16666667, 0.16666667, 8.0],
        [0.33333333, 0.16666667, 0.16666667, 16.0],
        [0.5, 0.16666667, 0.16666667, 8.0],
        [0.33333333, 0.33333333, 0.16666667, 8.0],
        [0.5, 0.33333333, 0.16666667, 8.0],
        [0.5, 0.5, 0.16666667, 2.0],
        [0.0, 0.0, 0.33333333, 2.0],
        [0.16666667, 0.0, 0.33333333, 8.0],
        [0.33333333, 0.0, 0.33333333, 8.0],
        [0.5, 0.0, 0.33333333, 4.0],
        [0.16666667, 0.16666667, 0.33333333, 8.0],
        [0.33333333, 0.16666667, 0.33333333, 16.0],
        [0.5, 0.16666667, 0.33333333, 8.0],
        [0.33333333, 0.33333333, 0.33333333, 8.0],
        [0.5, 0.33333333, 0.33333333, 8.0],
        [0.5, 0.5, 0.33333333, 2.0],
        [0.0, 0.0, 0.5, 1.0],
        [0.16666667, 0.0, 0.5, 4.0],
        [0.33333333, 0.0, 0.5, 4.0],
        [0.5, 0.0, 0.5, 2.0],
        [0.16666667, 0.16666667, 0.5, 4.0],
        [0.33333333, 0.16666667, 0.5, 8.0],
        [0.5, 0.16666667, 0.5, 4.0],
        [0.33333333, 0.33333333, 0.5, 4.0],
        [0.5, 0.33333333, 0.5, 4.0],
        [0.5, 0.5, 0.5, 1.0],
    ]
    @test irreciprocalmesh(rutile, [6, 6, 6]; is_shift = trues(3)) ≈ [
        [0.08333333, 0.08333333, 0.08333333, 8.0],
        [0.25, 0.08333333, 0.08333333, 16.0],
        [0.41666667, 0.08333333, 0.08333333, 16.0],
        [0.25, 0.25, 0.08333333, 8.0],
        [0.41666667, 0.25, 0.08333333, 16.0],
        [0.41666667, 0.41666667, 0.08333333, 8.0],
        [0.08333333, 0.08333333, 0.25, 8.0],
        [0.25, 0.08333333, 0.25, 16.0],
        [0.41666667, 0.08333333, 0.25, 16.0],
        [0.25, 0.25, 0.25, 8.0],
        [0.41666667, 0.25, 0.25, 16.0],
        [0.41666667, 0.41666667, 0.25, 8.0],
        [0.08333333, 0.08333333, 0.41666667, 8.0],
        [0.25, 0.08333333, 0.41666667, 16.0],
        [0.41666667, 0.08333333, 0.41666667, 16.0],
        [0.25, 0.25, 0.41666667, 8.0],
        [0.41666667, 0.25, 0.41666667, 16.0],
        [0.41666667, 0.41666667, 0.41666667, 8.0],
    ]
    # get_symmetry(rutile; symprec = 1e-5)
end

@testset "`spglib` doc example" begin  # See https://spglib.github.io/spglib/python-spglib.html#get-ir-reciprocal-mesh
    lattice = [
        0 0.5 0.5
        0.5 0 0.5
        0.5 0.5 0
    ] * 5.4
    positions = [[0.875, 0.875, 0.875], [0.125, 0.125, 0.125]]
    numbers = [1, 1]
    cell = Cell(numbers, positions, lattice)
    @test getspacegroup(cell) == ("Fd-3m", 227)
    @test irreciprocalmesh(cell, [8, 8, 8]) == [
        [0.0, 0.0, 0.0, 1.0],
        [0.125, 0.0, 0.0, 8.0],
        [0.25, 0.0, 0.0, 8.0],
        [0.375, 0.0, 0.0, 8.0],
        [0.5, 0.0, 0.0, 4.0],
        [0.125, 0.125, 0.0, 6.0],
        [0.25, 0.125, 0.0, 24.0],
        [0.375, 0.125, 0.0, 24.0],
        [0.5, 0.125, 0.0, 24.0],
        [-0.375, 0.125, 0.0, 24.0],
        [-0.25, 0.125, 0.0, 24.0],
        [-0.125, 0.125, 0.0, 12.0],
        [0.25, 0.25, 0.0, 6.0],
        [0.375, 0.25, 0.0, 24.0],
        [0.5, 0.25, 0.0, 24.0],
        [-0.375, 0.25, 0.0, 24.0],
        [-0.25, 0.25, 0.0, 12.0],
        [0.375, 0.375, 0.0, 6.0],
        [0.5, 0.375, 0.0, 24.0],
        [-0.375, 0.375, 0.0, 12.0],
        [0.5, 0.5, 0.0, 3.0],
        [0.375, 0.25, 0.125, 24.0],
        [0.5, 0.25, 0.125, 48.0],
        [-0.375, 0.25, 0.125, 24.0],
        [0.5, 0.375, 0.125, 24.0],
        [-0.375, 0.375, 0.125, 48.0],
        [-0.25, 0.375, 0.125, 24.0],
        [-0.375, 0.5, 0.125, 12.0],
        [-0.25, 0.5, 0.25, 6.0],
    ]
    @test irreciprocalmesh(cell, [8, 8, 8]; is_shift = trues(3)) == [
        [0.0625, 0.0625, 0.0625, 2.0],
        [0.1875, 0.0625, 0.0625, 6.0],
        [0.3125, 0.0625, 0.0625, 6.0],
        [0.4375, 0.0625, 0.0625, 6.0],
        [0.5625, 0.0625, 0.0625, 6.0],
        [-0.3125, 0.0625, 0.0625, 6.0],
        [-0.1875, 0.0625, 0.0625, 6.0],
        [-0.0625, 0.0625, 0.0625, 6.0],
        [0.1875, 0.1875, 0.0625, 6.0],
        [0.3125, 0.1875, 0.0625, 12.0],
        [0.4375, 0.1875, 0.0625, 12.0],
        [0.5625, 0.1875, 0.0625, 12.0],
        [-0.3125, 0.1875, 0.0625, 12.0],
        [-0.1875, 0.1875, 0.0625, 12.0],
        [-0.0625, 0.1875, 0.0625, 12.0],
        [0.3125, 0.3125, 0.0625, 6.0],
        [0.4375, 0.3125, 0.0625, 12.0],
        [0.5625, 0.3125, 0.0625, 12.0],
        [-0.3125, 0.3125, 0.0625, 12.0],
        [-0.1875, 0.3125, 0.0625, 12.0],
        [-0.0625, 0.3125, 0.0625, 12.0],
        [0.4375, 0.4375, 0.0625, 6.0],
        [0.5625, 0.4375, 0.0625, 12.0],
        [-0.3125, 0.4375, 0.0625, 12.0],
        [-0.1875, 0.4375, 0.0625, 12.0],
        [-0.0625, 0.4375, 0.0625, 12.0],
        [0.5625, 0.5625, 0.0625, 6.0],
        [-0.3125, 0.5625, 0.0625, 12.0],
        [-0.1875, 0.5625, 0.0625, 12.0],
        [-0.3125, -0.3125, 0.0625, 6.0],
        [-0.1875, -0.3125, 0.0625, 12.0],
        [-0.1875, -0.1875, 0.0625, 6.0],
        [0.1875, 0.1875, 0.1875, 2.0],
        [0.3125, 0.1875, 0.1875, 6.0],
        [0.4375, 0.1875, 0.1875, 6.0],
        [0.5625, 0.1875, 0.1875, 6.0],
        [-0.3125, 0.1875, 0.1875, 6.0],
        [-0.1875, 0.1875, 0.1875, 6.0],
        [0.3125, 0.3125, 0.1875, 6.0],
        [0.4375, 0.3125, 0.1875, 12.0],
        [0.5625, 0.3125, 0.1875, 12.0],
        [-0.3125, 0.3125, 0.1875, 12.0],
        [-0.1875, 0.3125, 0.1875, 12.0],
        [0.4375, 0.4375, 0.1875, 6.0],
        [0.5625, 0.4375, 0.1875, 12.0],
        [-0.3125, 0.4375, 0.1875, 12.0],
        [-0.1875, 0.4375, 0.1875, 12.0],
        [0.5625, 0.5625, 0.1875, 6.0],
        [-0.3125, 0.5625, 0.1875, 12.0],
        [-0.3125, -0.3125, 0.1875, 6.0],
        [0.3125, 0.3125, 0.3125, 2.0],
        [0.4375, 0.3125, 0.3125, 6.0],
        [0.5625, 0.3125, 0.3125, 6.0],
        [-0.3125, 0.3125, 0.3125, 6.0],
        [0.4375, 0.4375, 0.3125, 6.0],
        [0.5625, 0.4375, 0.3125, 12.0],
        [-0.3125, 0.4375, 0.3125, 12.0],
        [0.5625, 0.5625, 0.3125, 6.0],
        [0.4375, 0.4375, 0.4375, 2.0],
        [0.5625, 0.4375, 0.4375, 6.0],
    ]
end

@testset "Test silicon_dist structure" begin
    lattice = [
        4.01 0 0
        0 4 0
        0 0 3.99
    ]
    positions = [
        0.001 0 0
        0 0.5 0.5
        0.5 0 0.5
        0.5 0.5 0
        0.25 0.25 0.251
        0.25 0.75 0.75
        0.75 0.25 0.75
        0.75 0.75 0.25
    ]
    numbers = [14, 14, 14, 14, 14, 14, 14, 14]
    silicon_dist = Cell(numbers, positions, lattice)
    @test getspacegroup(silicon_dist) == ("P1", 1)
    @test irreciprocalmesh(silicon_dist, [6, 6, 6]) == [
        [0.0, 0.0, 0.0, 1.0],
        [0.16666667, 0.0, 0.0, 2.0],
        [0.33333333, 0.0, 0.0, 2.0],
        [0.5, 0.0, 0.0, 1.0],
        [0.0, 0.16666667, 0.0, 2.0],
        [0.16666667, 0.16666667, 0.0, 2.0],
        [0.33333333, 0.16666667, 0.0, 2.0],
        [0.5, 0.16666667, 0.0, 2.0],
        [-0.33333333, 0.16666667, 0.0, 2.0],
        [-0.16666667, 0.16666667, 0.0, 2.0],
        [0.0, 0.33333333, 0.0, 2.0],
        [0.16666667, 0.33333333, 0.0, 2.0],
        [0.33333333, 0.33333333, 0.0, 2.0],
        [0.5, 0.33333333, 0.0, 2.0],
        [-0.33333333, 0.33333333, 0.0, 2.0],
        [-0.16666667, 0.33333333, 0.0, 2.0],
        [0.0, 0.5, 0.0, 1.0],
        [0.16666667, 0.5, 0.0, 2.0],
        [0.33333333, 0.5, 0.0, 2.0],
        [0.5, 0.5, 0.0, 1.0],
        [0.0, 0.0, 0.16666667, 2.0],
        [0.16666667, 0.0, 0.16666667, 2.0],
        [0.33333333, 0.0, 0.16666667, 2.0],
        [0.5, 0.0, 0.16666667, 2.0],
        [-0.33333333, 0.0, 0.16666667, 2.0],
        [-0.16666667, 0.0, 0.16666667, 2.0],
        [0.0, 0.16666667, 0.16666667, 2.0],
        [0.16666667, 0.16666667, 0.16666667, 2.0],
        [0.33333333, 0.16666667, 0.16666667, 2.0],
        [0.5, 0.16666667, 0.16666667, 2.0],
        [-0.33333333, 0.16666667, 0.16666667, 2.0],
        [-0.16666667, 0.16666667, 0.16666667, 2.0],
        [0.0, 0.33333333, 0.16666667, 2.0],
        [0.16666667, 0.33333333, 0.16666667, 2.0],
        [0.33333333, 0.33333333, 0.16666667, 2.0],
        [0.5, 0.33333333, 0.16666667, 2.0],
        [-0.33333333, 0.33333333, 0.16666667, 2.0],
        [-0.16666667, 0.33333333, 0.16666667, 2.0],
        [0.0, 0.5, 0.16666667, 2.0],
        [0.16666667, 0.5, 0.16666667, 2.0],
        [0.33333333, 0.5, 0.16666667, 2.0],
        [0.5, 0.5, 0.16666667, 2.0],
        [-0.33333333, 0.5, 0.16666667, 2.0],
        [-0.16666667, 0.5, 0.16666667, 2.0],
        [0.0, -0.33333333, 0.16666667, 2.0],
        [0.16666667, -0.33333333, 0.16666667, 2.0],
        [0.33333333, -0.33333333, 0.16666667, 2.0],
        [0.5, -0.33333333, 0.16666667, 2.0],
        [-0.33333333, -0.33333333, 0.16666667, 2.0],
        [-0.16666667, -0.33333333, 0.16666667, 2.0],
        [0.0, -0.16666667, 0.16666667, 2.0],
        [0.16666667, -0.16666667, 0.16666667, 2.0],
        [0.33333333, -0.16666667, 0.16666667, 2.0],
        [0.5, -0.16666667, 0.16666667, 2.0],
        [-0.33333333, -0.16666667, 0.16666667, 2.0],
        [-0.16666667, -0.16666667, 0.16666667, 2.0],
        [0.0, 0.0, 0.33333333, 2.0],
        [0.16666667, 0.0, 0.33333333, 2.0],
        [0.33333333, 0.0, 0.33333333, 2.0],
        [0.5, 0.0, 0.33333333, 2.0],
        [-0.33333333, 0.0, 0.33333333, 2.0],
        [-0.16666667, 0.0, 0.33333333, 2.0],
        [0.0, 0.16666667, 0.33333333, 2.0],
        [0.16666667, 0.16666667, 0.33333333, 2.0],
        [0.33333333, 0.16666667, 0.33333333, 2.0],
        [0.5, 0.16666667, 0.33333333, 2.0],
        [-0.33333333, 0.16666667, 0.33333333, 2.0],
        [-0.16666667, 0.16666667, 0.33333333, 2.0],
        [0.0, 0.33333333, 0.33333333, 2.0],
        [0.16666667, 0.33333333, 0.33333333, 2.0],
        [0.33333333, 0.33333333, 0.33333333, 2.0],
        [0.5, 0.33333333, 0.33333333, 2.0],
        [-0.33333333, 0.33333333, 0.33333333, 2.0],
        [-0.16666667, 0.33333333, 0.33333333, 2.0],
        [0.0, 0.5, 0.33333333, 2.0],
        [0.16666667, 0.5, 0.33333333, 2.0],
        [0.33333333, 0.5, 0.33333333, 2.0],
        [0.5, 0.5, 0.33333333, 2.0],
        [-0.33333333, 0.5, 0.33333333, 2.0],
        [-0.16666667, 0.5, 0.33333333, 2.0],
        [0.0, -0.33333333, 0.33333333, 2.0],
        [0.16666667, -0.33333333, 0.33333333, 2.0],
        [0.33333333, -0.33333333, 0.33333333, 2.0],
        [0.5, -0.33333333, 0.33333333, 2.0],
        [-0.33333333, -0.33333333, 0.33333333, 2.0],
        [-0.16666667, -0.33333333, 0.33333333, 2.0],
        [0.0, -0.16666667, 0.33333333, 2.0],
        [0.16666667, -0.16666667, 0.33333333, 2.0],
        [0.33333333, -0.16666667, 0.33333333, 2.0],
        [0.5, -0.16666667, 0.33333333, 2.0],
        [-0.33333333, -0.16666667, 0.33333333, 2.0],
        [-0.16666667, -0.16666667, 0.33333333, 2.0],
        [0.0, 0.0, 0.5, 1.0],
        [0.16666667, 0.0, 0.5, 2.0],
        [0.33333333, 0.0, 0.5, 2.0],
        [0.5, 0.0, 0.5, 1.0],
        [0.0, 0.16666667, 0.5, 2.0],
        [0.16666667, 0.16666667, 0.5, 2.0],
        [0.33333333, 0.16666667, 0.5, 2.0],
        [0.5, 0.16666667, 0.5, 2.0],
        [-0.33333333, 0.16666667, 0.5, 2.0],
        [-0.16666667, 0.16666667, 0.5, 2.0],
        [0.0, 0.33333333, 0.5, 2.0],
        [0.16666667, 0.33333333, 0.5, 2.0],
        [0.33333333, 0.33333333, 0.5, 2.0],
        [0.5, 0.33333333, 0.5, 2.0],
        [-0.33333333, 0.33333333, 0.5, 2.0],
        [-0.16666667, 0.33333333, 0.5, 2.0],
        [0.0, 0.5, 0.5, 1.0],
        [0.16666667, 0.5, 0.5, 2.0],
        [0.33333333, 0.5, 0.5, 2.0],
        [0.5, 0.5, 0.5, 1.0],
    ]
end

@testset "Test MgB2 structure" begin
    a = 3.07
    c = 3.52
    lattice = [
        a 0 0
        -a/2 a/2*sqrt(3) 0
        0 0 c
    ]
    positions = [
        0 0 0
        1.0/3 2.0/3 0.5
        2.0/3 1.0/3 0.5
    ]
    numbers = [12, 5, 5]
    MgB2 = Cell(numbers, positions, lattice)
    @test getspacegroup(MgB2) == ("P6/mmm", 191)
    @test irreciprocalmesh(cell, [7, 7, 7]) - [
        [0.0, 0.0, 0.0, 1.0],
        [0.14285714, 0.0, 0.0, 6.0],
        [0.28571429, 0.0, 0.0, 6.0],
        [0.42857143, 0.0, 0.0, 6.0],
        [0.14285714, 0.14285714, 0.0, 6.0],
        [0.28571429, 0.14285714, 0.0, 12.0],
        [0.42857143, 0.14285714, 0.0, 6.0],
        [0.28571429, 0.28571429, 0.0, 6.0],
        [0.0, 0.0, 0.14285714, 2.0],
        [0.14285714, 0.0, 0.14285714, 12.0],
        [0.28571429, 0.0, 0.14285714, 12.0],
        [0.42857143, 0.0, 0.14285714, 12.0],
        [0.14285714, 0.14285714, 0.14285714, 12.0],
        [0.28571429, 0.14285714, 0.14285714, 24.0],
        [0.42857143, 0.14285714, 0.14285714, 12.0],
        [0.28571429, 0.28571429, 0.14285714, 12.0],
        [0.0, 0.0, 0.28571429, 2.0],
        [0.14285714, 0.0, 0.28571429, 12.0],
        [0.28571429, 0.0, 0.28571429, 12.0],
        [0.42857143, 0.0, 0.28571429, 12.0],
        [0.14285714, 0.14285714, 0.28571429, 12.0],
        [0.28571429, 0.14285714, 0.28571429, 24.0],
        [0.42857143, 0.14285714, 0.28571429, 12.0],
        [0.28571429, 0.28571429, 0.28571429, 12.0],
        [0.0, 0.0, 0.42857143, 2.0],
        [0.14285714, 0.0, 0.42857143, 12.0],
        [0.28571429, 0.0, 0.42857143, 12.0],
        [0.42857143, 0.0, 0.42857143, 12.0],
        [0.14285714, 0.14285714, 0.42857143, 12.0],
        [0.28571429, 0.14285714, 0.42857143, 24.0],
        [0.42857143, 0.14285714, 0.42857143, 12.0],
        [0.28571429, 0.28571429, 0.42857143, 12.0],
    ]
end

end
